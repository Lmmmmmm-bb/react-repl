<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preview</title>
    <style>
      html, body, #root {
        margin: 0;
        height: 100%;
      }

      html.dark {
        color-scheme: dark;
      }
    </style>
  </head>

  <body>
    <div id="root"></div>
  </body>

  <script type="importmap">
    <!-- IMPORTMAP_PLACEHOLDER -->
  </script>

  <script>
    const sandboxRoot = document.documentElement;
    const sandboxParentRoot = window.parent.document.documentElement;

    const strategy = {
      REACT_MOUNT: (payload) => window.parent.postMessage(payload),
      THEME_CHANGE: (payload) => sandboxRoot.classList.toggle('dark', payload.data === 'dark'),
      COMPILER_DONE: (payload) => {
        const prevAllStyles = document.querySelectorAll("style[data-file]");
        const prevModuleScript = document.getElementById("module-script");
        prevModuleScript && prevModuleScript.remove();

        const moduleScript = document.createElement('script');
        moduleScript.type = 'module';
        moduleScript.id = 'module-script';
        moduleScript.src = URL.createObjectURL(
          new Blob([payload.data], { type: 'application/javascript' })
        );
        moduleScript.onload = () => prevAllStyles.forEach(style => style.remove());

        prevModuleScript && URL.revokeObjectURL(prevModuleScript.src);
        document.body.appendChild(moduleScript);
      },
    };

    sandboxRoot.classList.toggle('dark', sandboxParentRoot.className.includes('dark'));

    window.addEventListener('message', ({ data }) => {
      const payload = typeof data === 'string' ? JSON.parse(data) : data;
      strategy[payload.type] && strategy[payload.type](payload);
    })
  </script>
</html>
